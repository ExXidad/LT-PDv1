//
// Created by Ivan Kalesnikau on 28.12.2022.
//

#ifndef LT_PD_MYMAIN_HPP
#define LT_PD_MYMAIN_HPP

#include "usart.h"
#include <cstring>
#include <stdio.h>
#include "Qpd.hpp"
#include "retarget.h"
#include <array>
#include "AxisMems.hpp"
#include "DriverMems.hpp"
#include "RegularMeshInterpolator.hpp"

//constexpr uint8_t MAXMESSAGELENGTH = 256;

#define MEMS_CLK_TIM htim17
#define MEMS_CLK_TIM_CH TIM_CHANNEL_1

#define MEMS_ENBL_PORT GPIOB
#define MEMS_ENBL_PIN GPIO_PIN_7

#define MEMS_X_TIM htim3
#define MEMS_X_TIM_CH TIM_CHANNEL_3
#define MEMS_Y_TIM htim3
#define MEMS_Y_TIM_CH TIM_CHANNEL_4

#define MEMS_X_AVD_SIZE 151
#define MEMS_Y_AVD_SIZE 151

constexpr double xAxisAngleToVoltageDifference[MEMS_X_AVD_SIZE]{
        -169.653, -166.205, -163.353, -160.606, -157.336, -154.459, \
-151.668, -148.722, -145.891, -143.189, -140.505, -137.799, -134.775, \
-132.124, -129.283, -126.8, -124.412, -121.904, -119.242, -116.645, \
-113.738, -111.421, -109.15, -106.394, -103.556, -101.475, -99.326, \
-96.957, -94.3893, -91.8778, -89.6218, -87.4857, -85.3226, -82.8338, \
-80.5278, -78.3802, -76.2288, -73.8881, -71.6785, -69.5968, -67.2013, \
-65.1396, -63.179, -60.7876, -58.7191, -56.8668, -55.0249, -52.8174, \
-50.3384, -48.1918, -46.1546, -44.308, -42.6584, -40.7893, -38.5535, \
-36.797, -35.0543, -33.1165, -31.2895, -29.5359, -27.3838, -25.3904, \
-23.7099, -21.7644, -19.7198, -18.0661, -16.4318, -14.6889, -12.8156, \
-10.8213, -8.93028, -7.06642, -5.1486, -3.20219, -1.2517, 0.642772, \
2.54872, 4.50167, 6.45611, 8.40866, 10.3649, 12.2862, 14.1741, \
16.0682, 17.949, 19.8068, 21.7447, 23.7276, 25.5713, 27.4252, \
29.3512, 31.218, 33.0508, 34.9361, 36.8309, 38.7217, 40.6636, \
42.6024, 44.4384, 46.301, 48.2267, 50.1362, 52.0134, 53.8459, \
55.7088, 57.6362, 59.6341, 61.6511, 63.6351, 65.5671, 67.4954, \
69.5075, 71.505, 73.4905, 75.557, 77.668, 79.7833, 81.8208, 83.955, \
86.1879, 88.304, 90.4451, 92.6829, 95.0462, 97.2256, 99.4292, \
101.755, 104.063, 106.446, 108.811, 111.128, 113.53, 115.893, \
118.292, 120.736, 123.136, 125.631, 128.036, 130.403, 132.876, \
135.537, 138.058, 140.563, 143.222, 145.944, 148.488, 151.145, \
153.859, 156.525, 159.238, 162.067
};

constexpr double yAxisAngleToVoltageDifference[MEMS_Y_AVD_SIZE]{
        -169.653, -166.205, -163.353, -160.606, -157.336, -154.459, \
-151.668, -148.722, -145.891, -143.189, -140.505, -137.799, -134.775, \
-132.124, -129.283, -126.8, -124.412, -121.904, -119.242, -116.645, \
-113.738, -111.421, -109.15, -106.394, -103.556, -101.475, -99.326, \
-96.957, -94.3893, -91.8778, -89.6218, -87.4857, -85.3226, -82.8338, \
-80.5278, -78.3802, -76.2288, -73.8881, -71.6785, -69.5968, -67.2013, \
-65.1396, -63.179, -60.7876, -58.7191, -56.8668, -55.0249, -52.8174, \
-50.3384, -48.1918, -46.1546, -44.308, -42.6584, -40.7893, -38.5535, \
-36.797, -35.0543, -33.1165, -31.2895, -29.5359, -27.3838, -25.3904, \
-23.7099, -21.7644, -19.7198, -18.0661, -16.4318, -14.6889, -12.8156, \
-10.8213, -8.93028, -7.06642, -5.1486, -3.20219, -1.2517, 0.642772, \
2.54872, 4.50167, 6.45611, 8.40866, 10.3649, 12.2862, 14.1741, \
16.0682, 17.949, 19.8068, 21.7447, 23.7276, 25.5713, 27.4252, \
29.3512, 31.218, 33.0508, 34.9361, 36.8309, 38.7217, 40.6636, \
42.6024, 44.4384, 46.301, 48.2267, 50.1362, 52.0134, 53.8459, \
55.7088, 57.6362, 59.6341, 61.6511, 63.6351, 65.5671, 67.4954, \
69.5075, 71.505, 73.4905, 75.557, 77.668, 79.7833, 81.8208, 83.955, \
86.1879, 88.304, 90.4451, 92.6829, 95.0462, 97.2256, 99.4292, \
101.755, 104.063, 106.446, 108.811, 111.128, 113.53, 115.893, \
118.292, 120.736, 123.136, 125.631, 128.036, 130.403, 132.876, \
135.537, 138.058, 140.563, 143.222, 145.944, 148.488, 151.145, \
153.859, 156.525, 159.238, 162.067
};

[[noreturn]] int myMain();

void HAL_UART_RxCpltCallback(UART_HandleTypeDef *huart);


#endif //LT_PD_MYMAIN_HPP
